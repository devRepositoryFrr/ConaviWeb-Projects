@{
    ViewData["Title"] = "Inventario";
}
@********************************************************************************************************************************************************************@
@*Formulario para el el Inventario de Transferencia Primaria al Archivo de Concentración*@
<div id="general">
    <div class="row">
        <div class="col-md-5 center-block">
            <img src="../img/encab2021.png" class="img-responsive" />
        </div>
        <div class="col-md-7 text-right">
            <label>
                SUBDIRECCIÓN GENERAL DE ADMINSTRACIÓN Y FINANCIAMIENTO<br />
                COORDINACIÓN GENERAL DE ADMINISTRACIÓN<br />
                DIRECCIÓN DE ADMINISTRACIÓN DE RECURSOS<br />
                DEPARTAMENTO DE UNIDADES DOCUMENTALES
            </label>
        </div>
    </div>
    <br />
    <div class="row form-group">
        <div class="col-md-12 text-center">
            <label>
                Inventario para el control del acervo documental en los archivos de trámite
            </label>
        </div>
    </div>
    <div class="row form-group">
        <div class="col-md-4">
            <label for="felaboracion_inventario">Fecha de elaboración del inventario:</label>
        </div>
        <div class="col-md-8">
            <label id="fechaElaboracion" class="form-control"></label>
        </div>
    </div>
    <div class="row form-group">
        <div class="col-md-4">
            <label>Fondo:</label>
        </div>
        <div class="col-md-8">
            <label class="form-control">CONAVI</label>
        </div>
    </div>
    <div class="row form-group">
        <div class="col-md-4">
            <label>Sección:</label>
        </div>
        <div class="col-md-8">
            <label class="form-control">Todas las secciones</label>
        </div>
    </div>
    <div class="row form-group">
        <div class="col-md-4">
            <label>Serie:</label>
        </div>
        <div class="col-md-8">
            <label class="form-control">Todas las series</label>
        </div>
    </div>
    <div class="row form-group">
        <div class="col-md-4">
            <label class="control-label">Unidad Administrativa:</label>
        </div>
        <div class="col-md-8">
            <label class="form-control" id="areaDescripcion">Aquí aparecerá la unidad administrativa ligada al usuario</label>
        </div>
    </div>
    <div class="row form-group">
        <div class="col-md-4">
            <label class="control-label">Área generadora:</label>
        </div>
        <div class="col-md-8">
            <label class="form-control" id="puestoDescripcion">Aquí aparecerá la unidad administrativa ligada al usuario</label>
        </div>
    </div>
    @*<div class="row form-group datepicker-group">
        <div class="col-md-4">
            <label class="control-label">Nombre del responsable del archivo de trámite:</label>
        </div>
        <div class="col-md-8">
            <label class="form-control" id="responsableArchivo">Aquí aparecerá el nombre del responsable</label>
        </div>
    </div>*@
    @*<div class="row form-group datepicker-group">
        <div class="col-md-6">
            <div class="row">
                <div class="col-md-6">
                    <label for="fechaEntrega">Fecha de la entrega:</label>
                </div>
                <div class="col-md-6">
                    <label id="fechaEntrega" class="form-control"></label>
                </div>
                <div class="col-md-12">
                    <p class="help-block"><small>En caso de una entrega-recepción se anota la última fecha del documento</small></p>
                </div>
            </div>
        </div>
    </div>*@
    <div class="row">
        <div class="col-md-12">
            <form id="formTable">
                <table id="tableExpControl" class="table">
                    <thead>
                        <tr>
                            <th rowspan="2">
                                No.
                            </th>
                            <th rowspan="2">
                                Código de clasificación archivística
                            </th>
                            <th rowspan="2">
                                Título del expediente
                            </th>
                            <th rowspan="2">
                                Descripción del asunto que trata cada expediente
                            </th>
                            <th colspan="2" class="text-center">
                                Fechas extremas
                            </th>
                            <th rowspan="2">
                                No. de legajos
                            </th>
                            <th rowspan="2">
                                No. de CD's y USB
                            </th>
                            <th rowspan="2">
                                No. de fojas
                            </th>
                            <th colspan="2" class="text-center">
                                Soporte documental
                            </th>
                            <th colspan="3" class="text-center">
                                Valor documental
                            </th>
                            <th colspan="3" class="text-center">
                                N° de años en el tipo de archivo
                            </th>
                            <th rowspan="2">
                                Ubicación del documento
                            </th>
                            <th rowspan="2">
                                Observaciones
                            </th>
                        </tr>
                        <tr>
                            <th>
                                Año de apertura
                            </th>
                            <th>
                                Año de cierre
                            </th>
                            <th>
                                Físico
                            </th>
                            <th>
                                Electr.
                            </th>
                            <th>
                                A
                            </th>
                            <th>
                                L
                            </th>
                            <th>
                                F/C
                            </th>
                            <th>
                                AT
                            </th>
                            <th>
                                AC
                            </th>
                            <th>
                                Total de años
                            </th>
                        </tr>
                    </thead>
                    <tbody>

                    </tbody>
                </table>
            </form>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <form id="formTable">
                <table id="table" class="table text-center">
                    <thead>
                        <tr>
                            <td colspan="4">
                                El presente inventario consta de <input type="text" size="1" id="fojas" value="1" /> fojas y ampara la cantidad de <u id="expedientes"></u> expedientes de los años <u id="anios"></u> ubicados en <u id="Ubicacion"></u> . Para los expedientes con documentos electrónicos, ampara la cantidad de <u id="PesoElectronicos"></u> (KB, MB, entre otros) almacenados en <u id="Almacenamiento"></u>.
                            </td>
                        </tr>
                        <tr>
                            <td style="width: 25%">
                                Elaboró
                            </td>
                            <td style="width: 25%">
                                Validó/Entrega
                            </td>
                            <td style="width: 25%">
                                Autorizó
                            </td>
                            <td style="width: 25%">
                                Recibe
                            </td>
                        </tr>
                        <tr>
                            <td><br /><br /><br /><br /></td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td>
                                <input type="text" id="txt_name_elab" class="form-control" placeholder="Nombre del servidor que elaboró el inventario" />
                                <input type="text" id="txt_cargo_elab" class="form-control" placeholder="Cargo del servidor que elaboró el inventario" />
                                Nombre, cargo y firma del servidor público que elaboró el inventario.
                            </td>
                            <td>
                                <input type="text" id="txt_name_titular" class="form-control" placeholder="Nombre del Titular del Área generadora quien valida el inventario" />
                                <input type="text" id="txt_cargo_titular" class="form-control" placeholder="Cargo del Titular del Área generadora quien valida el inventario" />
                                Nombre, cargo y firma del Titular del Área generadora quien valida el inventario.
                            </td>
                            <td>
                                <input type="text" id="txt_name_titular_dud" class="form-control" placeholder="Nombre del Titular del Departamento de Unidades Documentales" />
                                <input type="text" id="txt_cargo_titular_dud" class="form-control" placeholder="Cargo del Titular del Departamento de Unidades Documentales" />
                                Nombre, cargo y firma del Titular del Departamento de Unidades Documentales.
                            </td>
                            <td>
                                <input type="text" id="txt_name_recibe" class="form-control" placeholder="Nombre de la persona que recibe el cargo" />
                                Nombre y firma de la persona que recibe el cargo.
                            </td>
                        </tr>
                    </thead>
                </table>
            </form>
        </div>
    </div>
    @*Fin del formulario para el alta de expediente*@
    <hr />
    <button class="btn btn-primary form-control" onclick="imprimirElemento()">Imprimir</button>
</div>

<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.css">
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.js"></script>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script type="text/javascript">
        const urlParams = new URLSearchParams(window.location.search);
        const idInv = urlParams.get('id');
        $(document).ready(function () {
            showAlert();
            $.ajax({
                url: "@Url.Action("GetInventarioControlById", "InventarioControl")", // Url
                data: {
                    // Datos / Parámetros
                    Id: idInv
                },
                type: "post"  // Verbo HTTP
            }).done(function (result) {
                if (result.id != null) {
                    $('#areaDescripcion').text(result.nombreUnidadAdministrativa);
                    $('#puestoDescripcion').text(result.nombrePuesto);
                    //$('#responsableArchivo').text(result.nombreResponsableAT);
                    $('#fechaElaboracion').text(result.fechaElaboracion != null ? result.fechaElaboracion.substring(8, 10) + '/' + result.fechaElaboracion.substring(5, 7) + '/' + result.fechaElaboracion.substring(0, 4) : '');
                    //$('#fechaEntrega').text(result.fechaEntrega != null ? result.fechaEntrega.substring(8, 10) + '/' + result.fechaEntrega.substring(5, 7) + '/' + result.fechaEntrega.substring(0, 4) : '');
                    $('#Ubicacion').text(result.ubicacion != null ? result.ubicacion : '');
                    $('#PesoElectronicos').text(result.pesoElectronico);
                    $('#Almacenamiento').text(result.almacenamiento != null ? result.almacenamiento : '');

                    var urlTipo = "";
                    urlTipo = "/InventarioControl/GetExpedientesControlByIdInv";
                    table = $('#tableExpControl').DataTable({
                        "proccessing": true,
                        "serverSide": false,
                        "ajax": {
                            url: urlTipo,
                            data: { Id : idInv },
                            type: 'POST',
                            headers: { 'RequestVerificationToken': $('@Html.AntiForgeryToken()').val() },
                            complete: function () {
                                $("#spinner").hide();
                                var tableId = document.getElementById('tableExpControl');
                                var tBody = tableId.getElementsByTagName('tbody')[0];
                                var tableRow = tBody.getElementsByTagName('tr');
                                var fojas_tot = 0;
                                for (var t = 0; t < tableRow.length; t++) {
                                    const a = parseInt(tableRow[t].cells[8].innerText);
                                    fojas_tot += isNaN(a) ? 0 : a;
                                }
                                const anio_inicial = tableRow[0].cells[4].innerHTML;
                                const anio_final = tableRow[tableRow.length - 1].cells[5].innerHTML;
                                const anios = anio_inicial == anio_final ? anio_final : anio_inicial + '-' + anio_final;
                                //$('#fojas').val(fojas_tot);
                                $('#expedientes').text(tableRow.length);
                                $('#anios').text(anios);
                            }
                        },
                        "columnDefs": columns,
                        "order": [[0, "desc"]],
                        "autoWidth": true,
                        "destroy": true,
                        "scrollY": true,
                        "scrollCollapse": true,
                        "paging": false,
                        "searching": false,
                        "info": false,
                        "scrollX": true,
                        "fixedColumns": true,
                        "ordering": false,
                        "language": {
                            "sProcessing": "Procesando...",
                            "sLengthMenu": "Mostrar _MENU_ registros",
                            "sZeroRecords": "No se encontraron resultados",
                            "sEmptyTable": "Ningún dato disponible en esta tabla",
                            "sInfo": "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
                            "sInfoEmpty": "Mostrando registros del 0 al 0 de un total de 0 registros",
                            "sInfoFiltered": "(filtrado de un total de _MAX_ registros)",
                            "sInfoPostFix": "",
                            "sSearch": "Buscar:",
                            "sUrl": "",
                            "sInfoThousands": ",",
                            "sLoadingRecords": "Cargando...",
                            "oPaginate": {
                                "sFirst": "Primero",
                                "sLast": "Último",
                                "sNext": "Siguiente",
                                "sPrevious": "Anterior"
                            }
                        }
                    });
                } else {
                    $("#alertAjax").append(result);
                    showAlert();
                }
            })
            // Se ejecuta si se produjo un error.
            .fail(function (xhr, status, error) {
                // Mostramos un mensaje de error.
                //$("#ErrorAlert").show("slow").delay(2000).hide("slow");

                // Escondemos el Ajax Loader
                //$("#AjaxLoader").hide("slow");

                // Habilitamos el botón de Submit
                //$("#SubmitBtn").prop("disabled", false);
            })
            // Hacer algo siempre, haya sido exitosa o no.
            .always(function () {

            });
        });
        var columns = [
            { "name": "NoProg", "data": "noProg", "targets": 0 },
            {
                "data": null,
                "targets": 1,
                "render": function (data, type, row) {
                    //var fprimero = (new Date(row.fechaPrimeroAntiguo)).getFullYear();
                    //var freciente = (new Date(row.fechaUltimoReciente)).getFullYear();
                    //var periodo = freciente == fprimero ? fprimero : fprimero + '-' + freciente;
                    return row.codigo + '-' + row.consecutivo + '/' + row.periodo;
                }
            },
            { "name": "Nombre", "data": "nombre", "targets": 2 },
            { "name": "Descripcion", "data": "descripcion", "targets": 3 },
            {
                "name": "FechaPrimeroAntiguo",
                "data": "fechaPrimeroAntiguo",
                "targets": 4,
                "render": function (data, type, row) {
                    var fprimero = new Date(row.fechaPrimeroAntiguo);
                    var month = fprimero.getMonth() + 1;
                    var day = fprimero.getDate();
                    //return ((day < 10 ? '0' : '') + day + '/' + (month < 10 ? '0' : '') + month + '/' + fprimero.getFullYear());
                    return (fprimero.getFullYear());
                }
            },
            {
                "name": "FechaUltimoReciente",
                "data": "fechaUltimoReciente",
                "targets": 5,
                "render": function (data, type, row) {
                    var fprimero = new Date(row.fechaUltimoReciente);
                    var month = fprimero.getMonth() + 1;
                    var day = fprimero.getDate();
                    //return ((day < 10 ? '0' : '') + day + '/' + (month < 10 ? '0' : '') + month + '/' + fprimero.getFullYear());
                    return (fprimero.getFullYear());
                }
            },
            { "name": "Legajos", "data": "legajos", "targets": 6 },
            { "name": "CDs", "data": "cds", "targets": 7 },
            { "name": "Fojas", "data": "fojas", "targets": 8 },
            {
                "name": "Fisico",
                "data": "tipoSoporteDocumental",
                "targets": 9,
                "render": function (data, type, row) {
                    return row.tipoSoporteDocumental == 'Físico' ? 'X' : '';
                }
            },
            {
                "name": "Electronico",
                "data": "tipoSoporteDocumental",
                "targets": 10,
                "render": function (data, type, row) {
                    return row.tipoSoporteDocumental == 'Electrónico' ? 'X' : '';
                }
            },
            { "name": "VigDocValA", "data": "vigDocValA", "targets": 11 },
            { "name": "VigDocValL", "data": "vigDocValL", "targets": 12 },
            { "name": "VigDocValFC", "data": "vigDocValFC", "targets": 13 },
            { "name": "VigDocPlaConAT", "data": "vigDocPlaConAT", "targets": 14 },
            { "name": "VigDocPlaConAC", "data": "vigDocPlaConAC", "targets": 15 },
            { "name": "VigDocPlaConTot", "data": "vigDocPlaConTot", "targets": 16 },
            { "name": "Ubicacion", "data": "ubicacion", "targets": 17 },
            { "name": "Observaciones", "data": "observaciones", "targets": 18 },
        ];
        function showAlert() {
            setTimeout(function () {
                $("#alerta").fadeOut(1500);
            }, 3000);
            setTimeout(function () {
                $("#alerta").remove();
            }, 6000);
        }
        function imprimirElemento() {
            var ventana = window.open('', 'PRINT', 'height=600,width=800');
            ventana.document.write('<html><head><title>InvControlArchTramite' + '_' + idInv + '</title><link href="https://framework-gb.cdn.gob.mx/assets/styles/main.css" rel="stylesheet">');
            ventana.document.write('<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">');
            //ventana.document.write('<style type="text/css">@@page { size: A4 landscape; margin: 20px; counter-reset: page pages;} /*#mainHeader{display: table-header-group;}*/ #mainTable{page-break-after: always;} th{padding: 2px;} thead,td{padding: 2px; border: 1px solid #000;} table thead{counter-increment:page;}#mainHeader .pageHeader{width:200px;}#mainHeader .pageHeader::before {counter-increment: pages;content: "Hoja " counter(page) " de " counter(pages) " del inventario";}</style>');
            ventana.document.write('<style type="text/css">@@page { size: A4 landscape; margin: 20px; counter-reset: page pages;} th{padding: 2px;} thead,td{padding: 2px; border: 1px solid #000;}</style>');
            ventana.document.write('</head>');
            ventana.document.write('<table style="font-size:10px;width:100%;" id="mainTable"><thead id="mainHeader"><tr><th colspan="9" width="38%"><img src="../img/encab2021.png" style="width: 100%; height:100%;" /></th><th colspan="10" style="text-align: right;"><label style="text-align: right;">SUBDIRECCIÓN GENERAL DE ADMINSTRACIÓN Y FINANCIAMIENTO<br />COORDINACIÓN GENERAL DE ADMINISTRACIÓN<br />DIRECCIÓN DE ADMINISTRACIÓN DE RECURSOS<br />DEPARTAMENTO DE UNIDADES DOCUMENTALES</label></th></tr>');
            ventana.document.write('<tr><th colspan="19" style="text-align:center;"><label>Inventario general por expediente en el archivo de trámite</label></th></tr>');
            ventana.document.write('<tr><td colspan="19" style="text-align:right;padding:5px;"><span id="pageHeader">Hoja 1 de '+ $("#fojas").val() +' del inventario</span></td></tr>');
            ventana.document.write('<tr><td colspan="19"><label>Fecha de Elaboración del Inventario: ' + $('#fechaElaboracion').text() + '</label></td></tr>');
            ventana.document.write('<tr><td colspan="19"><label>Fondo: CONAVI</label></td></tr>');
            ventana.document.write('<tr><td colspan="19"><label>Sección: Todas las secciones</label></td></tr>');
            ventana.document.write('<tr><td colspan="19"><label>Serie: Todas las series</label></td></tr>');
            ventana.document.write('<tr><td colspan="19"><label>Unidad Administrativa: ' + $('#areaDescripcion').text() + '</label></td></tr>');
            ventana.document.write('<tr><td colspan="19"><label>Área generadora: ' + $("#puestoDescripcion").text() + '</label></td><tr></thead>');
            ventana.document.write('<tr><td rowspan="2" class="text-center"><label>No.</label></td><td rowspan="2" class="text-center"><label>Código de clasificación archivística:</label></td><td rowspan="2" class="text-center"><label>Título del expediente</label></td><td rowspan="2" class="text-center"><label>Descripción del asunto que trata cada expediente</label></td><td colspan="2" class="text-center"><label>Fechas extremas</label></td><td rowspan="2" class="text-center"><label>N° de legajos</label></td><td rowspan="2" class="text-center"><label>N° de Cds y USB</label></td><td rowspan="2" class="text-center"><label>N° de fojas</label></td><td colspan="2" class="text-center"><label>Soporte documental</label></td><td colspan="3" class="text-center"><label>Valor documental</label></td><td colspan="3" class="text-center"><label>N° de años en el tipo de archivo</label></td><td rowspan="2" class="text-center"><label>Ubicación del documento</label></td><td rowspan="2" class="text-center"><label>Observaciones</label></td></tr>');
            ventana.document.write('<tr><td class="text-center"><label>Año de apertura</label></td><td class="text-center"><label>Año de cierre</label></td><td class="text-center"><label>Físico</label></td><td class="text-center"><label>Electr.</label></td><td class="text-center"><label>A</label></td><td class="text-center"><label>L</label></td><td class="text-center"><label>F/C</label></td><td class="text-center"><label>AT</label></td><td class="text-center"><label>AC</label></td><td class="text-center"><label>Total de años</label></td></tr>');
            ventana.document.write('<tbody>');
            var tableId = document.getElementById('tableExpControl');
            var tBody = tableId.getElementsByTagName('tbody')[0];
            var tableRow = tBody.getElementsByTagName('tr');
            var fojas_tot = 0;
            for (var t = 0; t < tableRow.length; t++) {
                const a = parseInt(tableRow[t].cells[8].innerText);
                fojas_tot += isNaN(a) ? 0 : a;
                ventana.document.write('<tr>' + tableRow[t].innerHTML + '</tr>');
            }
            const anio_inicial = tableRow[0].cells[4].innerHTML;
            const anio_final = tableRow[tableRow.length - 1].cells[5].innerHTML;
            const anios = anio_inicial == anio_final ? anio_final : anio_inicial + '-' + anio_final;
            //for (var t = 0; t < 60; t++) {
            //    const a = parseInt(tableRow[0].cells[8].innerText);
            //    fojas_tot += isNaN(a) ? 0 : a;
            //    ventana.document.write('<tr>' + tableRow[0].innerHTML + '</tr>');
            //}
            ventana.document.write('<tr><td colspan="19">El presente inventario consta de <u>&nbsp;' + $("#fojas").val() + '&nbsp;</u> fojas y ampara la cantidad de <u>&nbsp;' + tableRow.length + '&nbsp;</u> expedientes de los años <u>&nbsp;' + anios + '&nbsp;</u> ubicados en <u>&nbsp;' + $('#Ubicacion').text() + '&nbsp;</u> . Para los expedientes con documentos electrónicos, ampara la cantidad de <u>&nbsp;' + $('#PesoElectronicos').text() + '&nbsp;</u> (MB) almacenados en <u>&nbsp;' + $('#Almacenamiento').text() + '&nbsp;</u> .</td></tr>');
            ventana.document.write('<tr><td colspan="19" style="padding:0px;"><table style="font-size:10px;width:100%;"><tr><td class="text-center" width="25%" style="border:0px;border-right:1px solid black;border-bottom:1px solid black;">Elaboró</td><td class="text-center" width="25%" style="border:0px;border-right:1px solid black;border-bottom:1px solid black;">Validó/Entrega</td><td class="text-center" width="25%" style="border:0px;border-right:1px solid black;border-bottom:1px solid black;">Autorizó</td><td class="text-center" width="25%" style="border:0px;border-bottom:1px solid black;">Recibe</td></tr>');
            ventana.document.write('<tr><td class="text-center" style="border:0px;border-right:1px solid black;border-bottom:1px solid black;"><br /><br /><br /><br /><br /></td><td class="text-center" style="border:0px;border-right:1px solid black;border-bottom:1px solid black;"><br /><br /><br /><br /><br /></td><td class="text-center" style="border:0px;border-right:1px solid black;border-bottom:1px solid black;"><br /><br /><br /><br /><br /></td><td class="text-center" style="border:0px;border-bottom:1px solid black;"><br /><br /><br /><br /><br /></td></tr>');
            ventana.document.write('<tr><td class="text-center" style="border:0px;border-right:1px solid black;">' + $('#txt_name_elab ').val() + '</td><td class="text-center" style="border:0px;border-right:1px solid black;">' + $('#txt_name_titular ').val() + '</td><td class="text-center" style="border:0px;border-right:1px solid black;">' + $('#txt_name_titular_dud ').val() + '</td><td class="text-center" style="border:0px;">' + $('#txt_name_recibe ').val() +'</td></tr>');
            ventana.document.write('<tr><td class="text-center" style="border:0px;border-right:1px solid black;">' + $('#txt_cargo_elab ').val() + '</td><td class="text-center" style="border:0px;border-right:1px solid black;">' + $('#txt_cargo_titular ').val() + '</td><td class="text-center" style="border:0px;border-right:1px solid black;">' + $('#txt_cargo_titular_dud ').val() + '</td></tr></table></td></tr>');
            //ventana.document.write('<tr><td class="text-center" style="border:0px;border-right:1px solid black;" style="border:0px;">Nombre, cargo y firma del servidor público que elaboró el inventario.</td><td class="text-center" style="border:0px;border-right:1px solid black;">Nombre, cargo y firma del Titular del Área generadora quien valida el inventario.</td><td class="text-center" style="border:0px;border-right:1px solid black;">Nombre, cargo y firma del Titular del Departamento de Unidades Documentales</td><td class="text-center" style="border:0px;">Nombre y firma de la persona que recibe el cargo.</td></tr></table></td></tr>');
            ventana.document.write('</tbody>');
            ventana.document.write('</table>');
            ventana.document.write('</body></html>');
            ventana.document.close();
            ventana.focus();
            //ventana.onbeforeprint = (event) => { alert(ventana.document.getElementById("pageHeader").innerHTML); };
            ventana.print();
            ventana.close();
        }
        //setTimeout(function () {
        //    imprimirElemento();
        //}, 2000);
    </script>
}